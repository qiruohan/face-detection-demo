import{o as d,c as l,b as o,t as u,f as p,l as k,v as y,a as f,d as C,m as g}from"./vendor-a240b8cd.js";import{_ as v}from"./index-f2c62d86.js";import{n as c,d as _,T as b}from"./faceApi-de678650.js";const L={name:"VideoCapture",emits:["video-ready","error"],data(){return{stream:null,errorMessage:null,mirror:!1,resolution:"low",constraints:{low:{width:640,height:480},medium:{width:1280,height:720},high:{width:1920,height:1080}}}},mounted(){this.initCamera()},beforeUnmount(){this.stopCamera()},methods:{async initCamera(){try{this.stopCamera();const t=this.constraints[this.resolution]||{};this.stream=await navigator.mediaDevices.getUserMedia({video:t}),this.$refs.videoRef.srcObject=this.stream,this.errorMessage=null}catch(t){this.errorMessage="Error accessing camera: "+t.message,this.$emit("error",t)}},stopCamera(){this.stream&&this.stream.getTracks&&this.stream.getTracks().forEach(t=>t.stop()),this.stream=null},onVideoLoaded(){this.$refs.videoRef&&this.$emit("video-ready",this.$refs.videoRef)},toggleMirror(){this.mirror=!this.mirror},changeResolution(){this.initCamera()}}},E={class:"video-container"},w={key:0,class:"error-message"},S={class:"controls"},M=["disabled"];function V(t,e,n,a,i,s){return d(),l("div",E,[o("video",{ref:"videoRef",autoplay:"",playsinline:"",width:"640",height:"480",onLoadeddata:e[0]||(e[0]=(...r)=>s.onVideoLoaded&&s.onVideoLoaded(...r))},null,544),i.errorMessage?(d(),l("div",w,u(i.errorMessage),1)):p("",!0),o("div",S,[o("button",{onClick:e[1]||(e[1]=(...r)=>s.toggleMirror&&s.toggleMirror(...r))},u(i.mirror?"Disable":"Enable")+" Mirror",1),o("button",{onClick:e[2]||(e[2]=(...r)=>s.stopCamera&&s.stopCamera(...r)),disabled:!i.stream},"Stop Camera",8,M),o("button",{onClick:e[3]||(e[3]=(...r)=>s.initCamera&&s.initCamera(...r))},"Start Camera"),k(o("select",{"onUpdate:modelValue":e[4]||(e[4]=r=>i.resolution=r),onChange:e[5]||(e[5]=(...r)=>s.changeResolution&&s.changeResolution(...r))},e[6]||(e[6]=[o("option",{value:"low"},"Low (640x480)",-1),o("option",{value:"medium"},"Medium (1280x720)",-1),o("option",{value:"high"},"High (1920x1080)",-1)]),544),[[y,i.resolution]])])])}const x=v(L,[["render",V],["__scopeId","data-v-5810dcca"]]),h="/models";async function F(){try{await Promise.all([c.tinyFaceDetector.loadFromUri(h),c.faceLandmark68Net.loadFromUri(h),c.faceExpressionNet.loadFromUri(h),c.ageGenderNet.loadFromUri(h)]),console.log("FaceAPI 模型加载完成")}catch(t){throw console.error("模型加载失败:",t),new Error("FaceAPI 模型加载失败")}}async function R(t){try{return await _(t,new b).withFaceLandmarks().withFaceExpressions().withAgeAndGender()||null}catch(e){return console.error("人脸检测失败:",e),null}}const H={name:"LivenessCheck",components:{VideoCapture:x},data(){return{videoElement:null,detectionStatus:"未检测",detectionLoading:!1,blinkDetected:!1,checkInterval:null,blinkHistory:[],eyeOpenThreshold:.2}},async mounted(){try{await F()}catch(t){console.error("模型加载失败:",t),this.detectionStatus="模型加载失败，请检查网络连接"}},beforeUnmount(){this.stopLivenessCheck()},methods:{handleVideoReady(t){this.videoElement=t},handleError(t){console.error("摄像头错误:",t),this.detectionStatus="摄像头访问失败，请检查权限或设备"},async startLivenessCheck(){if(!this.videoElement){alert("无法访问摄像头视频，请检查是否允许权限");return}this.detectionLoading=!0,this.detectionStatus="检测中...",this.checkInterval=setInterval(async()=>{const t=await R(this.videoElement);if(!t){this.detectionStatus="未检测到人脸";return}const{landmarks:e}=t,n=e.getLeftEye(),a=e.getRightEye(),i=this.getEyeOpenScore(n),s=this.getEyeOpenScore(a),r=i<this.eyeOpenThreshold||s<this.eyeOpenThreshold;this.updateBlinkHistory(r),this.detectionStatus=r?"检测到眨眼":"双眼睁开",this.blinkDetected=this.isBlinkConfirmed()},500)},stopLivenessCheck(){this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.detectionLoading=!1,this.detectionStatus="检测停止"},getEyeOpenScore(t){if(!t||t.length<6)return 0;const e=t[1].y,n=t[4].y,a=Math.abs(t[0].x-t[3].x);return Math.abs(e-n)/a},updateBlinkHistory(t){this.blinkHistory.push(t),this.blinkHistory.length>5&&this.blinkHistory.shift()},isBlinkConfirmed(){return this.blinkHistory.filter(e=>e).length>=Math.ceil(this.blinkHistory.length/2)}}},I={class:"liveness-check"},O={class:"status"},D={class:"controls"},U=["disabled"],B=["disabled"],T={class:"feedback"},N={key:0},A={key:1};function G(t,e,n,a,i,s){const r=f("VideoCapture");return d(),l("div",I,[C(r,{onVideoReady:s.handleVideoReady,onError:s.handleError},null,8,["onVideoReady","onError"]),o("div",O,[o("p",null,[e[2]||(e[2]=g("Status: ")),o("strong",null,u(i.detectionStatus),1)])]),o("div",D,[o("button",{onClick:e[0]||(e[0]=(...m)=>s.startLivenessCheck&&s.startLivenessCheck(...m)),disabled:i.detectionLoading||!i.videoElement},u(i.detectionLoading?"检测中...":"开始检测"),9,U),o("button",{onClick:e[1]||(e[1]=(...m)=>s.stopLivenessCheck&&s.stopLivenessCheck(...m)),disabled:!i.detectionLoading}," 停止检测 ",8,B)]),o("div",T,[i.blinkDetected?(d(),l("p",N,e[3]||(e[3]=[g("检测到眨眼："),o("span",null,"是",-1)]))):(d(),l("p",A,e[4]||(e[4]=[g("检测到眨眼："),o("span",null,"否",-1)])))])])}const q=v(H,[["render",G],["__scopeId","data-v-c3db51b2"]]);export{q as default};
